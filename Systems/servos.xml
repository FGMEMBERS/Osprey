<?xml version="1.0"?>

<PropertyList>

    <!-- Move and limit the tilt of the left and right nacelles (the rotors)
         within a certain range. This range is dependent on the speed of the
         aircraft.

         For example, if we consider 0 degrees when the rotors are tilted
         horizontally and 90 degrees when they are vertical, then the
         minimum tilt goes from 97.5 degrees at 0 knots to 95 degrees at
         60 knots, to 80 degrees at 100 knots, to 30 degrees at 185 knots,
         and to 3 degrees at 200 knots. The maximum tilt is 60 degrees
         between 0 and 40 knots, decreases to 30 degrees at 80 knots, and
         0 degrees (rotors horizontal) at 105 knots.

         This range is called the "conversion corridor" and allows the
         V-22 to operate as a helicopter or aircraft.

            x
            |          x
         90 |
            |
         80 |                  x
            |
         70 |
            |
         60 x      x
            |
         50 |
            |
         40 |
            |
         30 |              x                    x
            |
         20 |
            |
         10 |
            |                                      x
            +- - - - - - - - - -x- - - - - - - - - x
                  40  60  80  105             185
    -->

    <filter>
        <name>Nacelles Minimum Tilt</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <expression>
                <table>
                    <property>/velocities/airspeed-kt</property>
                    <entry><ind>0</ind><dep>-7.5</dep></entry>
                    <entry><ind>60</ind><dep>-5</dep></entry>
                    <entry><ind>100</ind><dep>10</dep></entry>
                    <entry><ind>185</ind><dep>60</dep></entry>
                    <entry><ind>200</ind><dep>87</dep></entry>
                </table>
            </expression>
        </input>
        <output>
            <property>/sim/model/v22/min_allowed_tilt</property>
        </output>
    </filter>

    <filter>
        <name>Nacelles Maximum Tilt</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <expression>
                <table>
                    <property>/velocities/airspeed-kt</property>
                    <entry><ind>40</ind><dep>30</dep></entry>
                    <entry><ind>80</ind><dep>60</dep></entry>
                    <entry><ind>105</ind><dep>90</dep></entry>
                </table>
            </expression>
        </input>
        <output>
            <property>/sim/model/v22/max_allowed_tilt</property>
        </output>
    </filter>

    <!-- Simulates the servos of the tilting mechanism. Without this
         filter, changes of the requested tilt rate (controlled via
         the nacelles control wheel on the TCL) would be instantaneous.
    -->
    <filter>
        <name>Nacelles Servos</name>
        <type>noise-spike</type>
        <input>
            <property>/v22/pfcs/target/tilt-rate</property>
            <abs type="bool">true</abs>
        </input>
        <output>
            <property>/v22/pfcs/output/tilt-rate</property>
        </output>

        <!-- Set the maximum tilt rate to 0 deg/s during replay
             in order to pause any movement of the nacelles.
        -->
        <max>
            <condition>
                <property>/sim/freeze/replay-state</property>
            </condition>
            <value>0.0</value>
        </max>

        <!-- Set minimum tilt rate to 8 deg/s if nacelles need to tilt
             in order to stay within the allowed range.
        -->
        <min>
            <condition>
                <or>
                    <less-than>
                        <property>/sim/model/v22/tilt</property>
                        <property>/sim/model/v22/min_allowed_tilt</property>
                    </less-than>
                    <less-than>
                        <property>/sim/model/v22/max_allowed_tilt</property>
                        <property>/sim/model/v22/tilt</property>
                    </less-than>
                </or>
            </condition>
            <value>8.0</value>
        </min>

        <!-- Tilt rate is always positive because it is used as the
             maximum rate of change in the Nacelles Tilt Limit filter.
             The input property of that filter controls the direction
             of the tilt movement.
        -->
        <min>0.0</min>
        <max>8.0</max>

        <!-- TODO Speed (full range in 0.5 seconds) is a guess! -->
        <!-- From 0 to 8 deg/s in 0.5 second -->
        <max-rate-of-change>16.0</max-rate-of-change>
    </filter>

    <!-- Simulates the moving of the nacelles. The allowed range
         is limited by the speed of the aircraft.
    -->
    <filter>
        <name>Nacelles Tilt Limit</name>
        <type>noise-spike</type>
        <enable>
            <condition>
                <equals>
                    <property>/sim/model/v22/wing_state</property>
                    <value>0</value>
                </equals>
            </condition>
        </enable>
        <input>
            <property>/v22/pfcs/target/tilt</property>
            <min>
                <property>/sim/model/v22/min_allowed_tilt</property>
            </min>
            <max>
                <property>/sim/model/v22/max_allowed_tilt</property>
            </max>
        </input>
        <output>
            <property>/v22/pfcs/output/tilt</property>
        </output>

        <!-- Tilt rate can be at most 8 deg/s, which is roughly 90 degrees
             in 12 seconds.
        -->
        <max-rate-of-change>
            <property>/v22/pfcs/output/tilt-rate</property>
        </max-rate-of-change>
    </filter>

    <!-- The whole purpose of this filter is to make sure that the
         recorded tilt does not get overridden by the Nacelles Tilt Limit
         filter during replay, while at the same time working around a
         bug that causes the input of that filter to be passed to the output
         without adhering to the max-rate-of-change property (which can be zero).
    -->
    <filter>
        <name>Nacelles Tilt Buffer For Non Replay State</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <condition>
                <and>
                    <not>
                        <property>/sim/freeze/replay-state</property>
                    </not>
                    <equals>
                        <property>/sim/model/v22/wing_state</property>
                        <value>0</value>
                    </equals>
                </and>
            </condition>
        </enable>
        <input>
            <property>/v22/pfcs/output/tilt</property>
        </input>
        <output>
            <property>/sim/model/v22/tilt</property>
            <property>/sim/model/v22/animation_tilt</property>
        </output>
    </filter>

    <!-- Simulate the servo motors of the two ailerons by limiting the
         rate of change of the two flight control surfaces. -->
    <filter>
        <name>Ailerons Servos</name>
        <type>noise-spike</type>
        <input>
            <property>/v22/pfcs/output/aileron</property>
            <condition>
                <property>/v22/pfcs/active/roll-rate-in-air</property>
            </condition>
            <!-- Since the ailerons are driven by a PID controller
                 which controls the roll rate, the controller will
                 cause maximum deflection during low speeds, because
                 the ailerons are not very effective at low speeds.

                 Scaling by a factor makes sure that the ailerons are
                 neutral at low speeds, which looks better.
            -->
            <scale>
                <expression>
                    <!-- 0.0 if speed <= 40 kts, 1.0 if speed >= 60 kts -->
                    <table>
                        <property>/velocities/airspeed-kt</property>
                        <entry><ind>40</ind><dep>0.0</dep></entry>
                        <entry><ind>60</ind><dep>1.0</dep></entry>
                    </table>
                </expression>
            </scale>
        </input>
        <input>
            <property>/v22/pfcs/output/aileron</property>
        </input>
        <output>
            <property>/sim/model/v22/wing/aileron</property>
        </output>

        <!-- Range is relative to the current position of the flaps.
             0.0 means current position of flaps. Min and max should be
             equal because they reflect the ratio of right aileron to
             left aileron deflection.

             Range flaperons:
                - APLN: -40 ..  20 degrees
                - VTOL: -90 .. -73 degrees

             Due to limitations of YASim, the two flaperons cannot be
             controlled individually, so range cannot be properly restricted.
        -->
        <min>-0.5</min>
        <max> 0.5</max>

        <!-- TODO Speed (full range in 2 seconds) is a guess! -->
        <!-- range (-1..1 = 2) in 2 seconds -->
        <max-rate-of-change>1</max-rate-of-change>
    </filter>

    <!-- Simulate the servo motors of the elevator by limiting the
         rate of change of the flight control surface. -->
    <filter>
        <name>Elevator Servos</name>
        <type>noise-spike</type>
        <input>
            <property>/v22/pfcs/output/elevator</property>
        </input>
        <output>
            <property>/sim/model/v22/wing/elevator</property>
        </output>

        <!-- Range: -20 .. 30 degrees. Note that the surface is inverted
             in the FDM so min represents the up and max represents down.
        -->
        <min>-1.00</min>
        <max> 0.67</max>

        <!-- TODO Speed (full range in 1 second) is a guess! -->
        <!-- range (-1..1 = 2) in 1 second -->
        <max-rate-of-change>2</max-rate-of-change>
    </filter>

    <!-- Simulate the servo motors of the two rudders by limiting the
         rate of change of the two flight control surfaces. -->
    <filter>
        <name>Rudders Servos</name>
        <type>noise-spike</type>
        <input>
            <property>/v22/pfcs/target/yaw</property>
        </input>
        <output>
            <property>/sim/model/v22/wing/rudder</property>
        </output>

        <!-- Range: -20 .. 20 degrees -->
        <min>-1.0</min>
        <max> 1.0</max>

        <!-- TODO Speed (full range in 1 second) is a guess! -->
        <!-- range (-1..1 = 2) in 1 second -->
        <max-rate-of-change>2</max-rate-of-change>
    </filter>

    <!-- Simulates the moving of the Thrust Control Lever (TCL). Without
         this filter, changes in the requested throttle would be
         instantaneous. This is especially needed when the A/P controls
         the throttle.
    -->
    <filter>
        <name>Thrust Control Lever (TCL) Servos</name>
        <type>noise-spike</type>
        <input>
            <property>/v22/afcs/output/throttle</property>
        </input>
        <output>
            <property>/v22/pfcs/output/tcl</property>
        </output>

        <min>0.0</min>
        <max>1.0</max>

        <max-rate-of-change>1.0</max-rate-of-change>
    </filter>

    <filter>
        <type>derivative</type>
        <filter-time>1.0</filter-time>
        <input>
            <property>/gear/gear[0]/position-norm</property>
        </input>
        <output>
            <property>/gear/gear[0]/position-normps</property>
        </output>
    </filter>

</PropertyList>
