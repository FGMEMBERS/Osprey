<?xml version="1.0"?>

<PropertyList>

    <!-- Move and limit the tilt of the left and right nacelles (the rotors)
         within a certain range. This range is dependent on the speed of the
         aircraft.

         For example, if we consider 0 degrees when the rotors are tilted
         horizontally and 90 degrees when they are vertical, then the
         minimum tilt goes from 97.5 degrees at 0 knots to 95 degrees at
         60 knots, to 80 degrees at 100 knots, to 30 degrees at 185 knots,
         and to 3 degrees at 200 knots. The maximum tilt is 60 degrees
         between 0 and 40 knots, decreases to 30 degrees at 80 knots, and
         0 degrees (rotors horizontal) at 105 knots.

         This range is called the "conversion corridor" and allows the
         V-22 to operate as a helicopter or aircraft.

            x
            |          x
         90 |
            |
         80 |                  x
            |
         70 |
            |
         60 x      x
            |
         50 |
            |
         40 |
            |
         30 |              x                    x
            |
         20 |
            |
         10 |
            |                                      x
            +- - - - - - - - - -x- - - - - - - - - x
                  40  60  80  105             185
    -->

    <filter>
        <name>Nacelles Minimum Tilt</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <expression>
                <table>
                    <property>/velocities/airspeed-kt</property>
                    <entry><ind>0</ind><dep>-7.5</dep></entry>
                    <entry><ind>60</ind><dep>-5</dep></entry>
                    <entry><ind>100</ind><dep>10</dep></entry>
                    <entry><ind>185</ind><dep>60</dep></entry>
                    <entry><ind>200</ind><dep>87</dep></entry>
                </table>
            </expression>
        </input>
        <output>
            <property>/sim/model/v22/min_allowed_tilt</property>
        </output>
    </filter>

    <filter>
        <name>Nacelles Maximum Tilt</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <expression>
                <table>
                    <property>/velocities/airspeed-kt</property>
                    <entry><ind>40</ind><dep>30</dep></entry>
                    <entry><ind>80</ind><dep>60</dep></entry>
                    <entry><ind>105</ind><dep>90</dep></entry>
                </table>
            </expression>
        </input>
        <output>
            <property>/sim/model/v22/max_allowed_tilt</property>
        </output>
    </filter>

    <!-- Simulates the servos of the tilting mechanism. Without this
         filter, changes of the requested tilt rate (controlled via
         the nacelles control wheel on the TCL) would be instantaneous.
    -->
    <filter>
        <name>Nacelles Servos</name>
        <type>noise-spike</type>
        <input>
            <property>/controls/flight/fbw/target/tilt-rate</property>
            <abs type="bool">true</abs>
        </input>
        <output>
            <property>/controls/flight/fbw/output/tilt-rate</property>
        </output>

        <!-- Set minimum tilt rate to 8 deg/s if nacelles need to tilt
             in order to stay within the allowed range.
        -->
        <min>
            <condition>
                <or>
                    <less-than>
                        <property>/sim/model/v22/rotor/left/tilt</property>
                        <property>/sim/model/v22/min_allowed_tilt</property>
                    </less-than>
                    <less-than>
                        <property>/sim/model/v22/max_allowed_tilt</property>
                        <property>/sim/model/v22/rotor/left/tilt</property>
                    </less-than>
                </or>
            </condition>
            <value>8.0</value>
        </min>

        <!-- Tilt rate is always positive because it is used as the
             maximum rate of change in the Nacelles Tilt Limit filter.
             The input property of that filter controls the direction
             of the tilt movement.
        -->
        <min>0.0</min>
        <max>8.0</max>

        <!-- TODO Speed (full range in 0.5 seconds) is a guess! -->
        <!-- From 0 to 8 deg/s in 0.5 second -->
        <max-rate-of-change>16.0</max-rate-of-change>
    </filter>

    <!-- Simulates the moving of the nacelles. The allowed range
         is limited by the speed of the aircraft.
    -->
    <filter>
        <name>Nacelles Tilt Limit</name>
        <type>noise-spike</type>
        <enable>
            <condition>
                <and>
                    <equals>
                        <property>/sim/model/v22/wing_state</property>
                        <value>0</value>
                    </equals>
                    <not>
                        <property>/sim/freeze/replay-state</property>
                    </not>
                </and>
            </condition>
        </enable>
        <input>
            <property>/controls/flight/fbw/target/tilt</property>
            <min>
                <property>/sim/model/v22/min_allowed_tilt</property>
            </min>
            <max>
                <property>/sim/model/v22/max_allowed_tilt</property>
            </max>
        </input>
        <output>
            <property>/sim/model/v22/rotor/left/tilt</property>
            <property>/sim/model/v22/rotor/right/tilt</property>
            <property>/sim/model/v22/rotor/left/animation_tilt</property>
            <property>/sim/model/v22/rotor/right/animation_tilt</property>
        </output>

        <!-- Tilt rate can be at most 8 deg/s, which is roughly 90 degrees
             in 12 seconds.
        -->
        <max-rate-of-change>
            <property>/controls/flight/fbw/output/tilt-rate</property>
        </max-rate-of-change>
    </filter>

    <!-- Simulate the servo motors of the two ailerons by limiting the
         rate of change of the two flight control surfaces. -->
    <filter>
        <name>Ailerons Servos</name>
        <type>noise-spike</type>
        <input>
            <property>/controls/flight/fbw/output/aileron</property>
            <condition>
                <property>/controls/flight/fbw/active/roll-rate</property>
            </condition>
            <!-- Since the ailerons are driven by a PID controller
                 which controls the roll rate, the controller will
                 cause maximum deflection during low speeds, because
                 the ailerons are not very effective at low speeds.

                 Scaling by a factor makes sure that the ailerons are
                 neutral at low speeds, which looks better.
            -->
            <scale>
                <expression>
                    <!-- 0.0 if speed <= 40 kts, 1.0 if speed >= 60 kts -->
                    <table>
                        <property>/velocities/airspeed-kt</property>
                        <entry><ind>40</ind><dep>0.0</dep></entry>
                        <entry><ind>60</ind><dep>1.0</dep></entry>
                    </table>
                </expression>
            </scale>
        </input>
        <input>
            <property>/controls/flight/fbw/output/aileron</property>
        </input>
        <output>
            <property>/sim/model/v22/wing/aileron</property>
        </output>

        <!-- Range is relative. 0.0 means current position of flaps -->
        <min>-0.5</min>
        <max>0.5</max>

        <!-- TODO Speed (full range in 2 seconds) is a guess! -->
        <!-- range (-1..1 = 2) in 2 seconds -->
        <max-rate-of-change>1</max-rate-of-change>
    </filter>

    <!-- Simulate the servo motors of the elevator by limiting the
         rate of change of the flight control surface. -->
    <filter>
        <name>Elevator Servos</name>
        <type>noise-spike</type>
        <input>
            <property>/controls/flight/fbw/output/elevator</property>
        </input>
        <output>
            <property>/sim/model/v22/wing/elevator</property>
        </output>
        <min>-1.0</min>
        <max>1.0</max>

        <!-- TODO Speed (full range in 1 second) is a guess! -->
        <!-- range (-1..1 = 2) in 1 second -->
        <max-rate-of-change>2</max-rate-of-change>
    </filter>

    <!-- Simulate the servo motors of the two rudders by limiting the
         rate of change of the two flight control surfaces. -->
    <filter>
        <name>Rudders Servos</name>
        <type>noise-spike</type>
        <input>
            <property>/controls/flight/fbw/target/yaw</property>
        </input>
        <output>
            <property>/sim/model/v22/wing/rudder</property>
        </output>
        <min>-1.0</min>
        <max>1.0</max>

        <!-- TODO Speed (full range in 1 second) is a guess! -->
        <!-- range (-1..1 = 2) in 1 second -->
        <max-rate-of-change>2</max-rate-of-change>
    </filter>

</PropertyList>
