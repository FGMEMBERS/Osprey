<?xml version="1.0" encoding="UTF-8"?>

<!--
    Copyright (c) 2014 onox

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<PropertyList>

    <!--
         Sources:
            [1]  http://www.globalsecurity.org/military/systems/aircraft/v-22-vrs.htm
    -->

    <!-- ================================================================== -->
    <!-- Roll Axis Modes                                                    -->
    <!-- ================================================================== -->

    <!-- Enable A/P TACAN if aircraft is in range and TACAN
         mode selected in A/P.
    -->
    <logic>
        <name>A/P TACAN On/Off Switcher</name>
        <input>
            <and>
                <equals>
                    <property>/v22/afcs/locks/heading</property>
                    <value>tacan-hold</value>
                </equals>
                <property>/instrumentation/tacan/in-range</property>
                <not>
                    <property>/v22/afcs/active/loc-hold</property>
                </not>
            </and>
        </input>
        <output>
            <property>/v22/afcs/active/tacan-hold</property>
        </output>
    </logic>

    <!-- Enable A/P WYPT if WYPT mode selected in A/P -->
    <logic>
        <name>A/P WYPT On/Off Switcher</name>
        <input>
            <and>
                <property>/autopilot/settings/gps-driving-true-heading</property>
                <equals>
                    <property>/autopilot/locks/heading</property>
                    <value>true-heading-hold</value>
                </equals>
            </and>
        </input>
        <output>
            <property>/v22/afcs/active/wypt-hold</property>
        </output>
    </logic>

    <!-- Enable A/P NAV1 Localizer if localizer is in range and NAV1
         mode selected in A/P.
    -->
    <logic>
        <name>A/P NAV1 Localizer On/Off Switcher</name>
        <input>
            <and>
                <property>/v22/afcs/locks/vor-ils</property>
                <not>
                    <property>/v22/afcs/active/tacan-hold</property>
                </not>
                <or>
                    <!-- NAV1 must be an ILS localizer -->
                    <and>
                        <property>/instrumentation/nav[0]/loc/in-range</property>
                        <not-equals>
                            <property>/instrumentation/nav[0]/loc/ident</property>
                            <value></value>
                        </not-equals>
                    </and>

                    <!-- Or a VOR beacon -->
                    <and>
                        <property>/instrumentation/nav[0]/vor/in-range</property>
                        <not-equals>
                            <property>/instrumentation/nav[0]/vor/ident</property>
                            <value></value>
                        </not-equals>
                    </and>
                </or>
                <greater-than>
                    <property>/instrumentation/nav[0]/signal-quality-norm</property>
                    <value>0.85</value>
                </greater-than>
                <or>
                    <!-- The localizer should only be captured when the
                         aircraft is close to the signal's crosstrack.
                    -->
                    <less-than>
                        <expression>
                            <abs>
                                <property>/instrumentation/nav[0]/heading-needle-deflection-norm</property>
                            </abs>
                        </expression>
                        <value>1.0</value>
                    </less-than>

                    <!-- Once the aircraft has been within the width of the
                         signal and the localizer was captured, this filter
                         should not be switched off in case the aircraft
                         temporarily flies away from the signal again.
                    -->
                    <property>/v22/afcs/active/loc-hold</property>
                </or>
            </and>
        </input>
        <output>
            <property>/v22/afcs/active/loc-hold</property>
        </output>
    </logic>

    <!-- Filter which sets the desired roll angle to zero in order to
         level the wings.
    -->
    <filter>
        <name>A/P Wing Leveler</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <condition>
                <and>
                    <equals>
                        <property>/autopilot/locks/heading</property>
                        <value>wing-leveler</value>
                    </equals>
                    <property>/v22/pfcs/active/roll-axis-unconstrained</property>
                </and>
                <not>
                    <or>
                        <property>/v22/afcs/active/loc-hold</property>
                        <property>/v22/afcs/active/tacan-hold</property>
                    </or>
                </not>
            </condition>
        </enable>
        <input>
            <value>0.0</value>
        </input>
        <output>
            <property>/v22/pfcs/target/roll-deg</property>
        </output>
    </filter>

    <!-- This filter computes the heading bug error relative to the
         magnetic heading set in the A/P. It is positive if the current
         magnetic heading of the aircraft is to the left of the requested
         heading and negative if the current heading is to the right.
    -->
    <filter>
        <name>A/P Magnetic Heading Bug Error Computer</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <condition>
                <and>
                    <equals>
                        <property>/autopilot/locks/heading</property>
                        <value>dg-heading-hold</value>
                    </equals>
                    <not>
                        <or>
                            <property>/v22/afcs/active/loc-hold</property>
                            <property>/v22/afcs/active/tacan-hold</property>
                        </or>
                    </not>
                </and>
            </condition>
        </enable>
        <input>
            <property>/autopilot/settings/heading-bug-deg</property>
        </input>
        <reference>
            <property>/orientation/heading-magnetic-deg</property>
        </reference>
        <output>
            <property>/v22/afcs/internal/heading-bug-error-deg</property>
        </output>
        <period>
            <min>-180</min>
            <max>180</max>
        </period>
    </filter>

    <!-- Computes the GPS track heading bug error relative to the true 
         heading set in the A/P. This filter basically works the same
         way as the filter above using the magnetic heading.
    -->
    <filter>
        <name>A/P GPS Track True Heading Bug Error Computer</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <condition>
                <and>
                    <property>/v22/afcs/active/wypt-hold</property>
                    <not>
                        <or>
                            <property>/v22/afcs/active/loc-hold</property>
                            <property>/v22/afcs/active/tacan-hold</property>
                        </or>
                    </not>
                </and>
            </condition>
        </enable>
        <input>
            <property>/autopilot/settings/true-heading-deg</property>
        </input>
        <reference>
            <property>/instrumentation/gps/indicated-track-true-deg</property>
        </reference>
        <output>
            <property>/v22/afcs/internal/heading-bug-error-deg</property>
        </output>
        <period>
            <min>-180</min>
            <max>180</max>
        </period>
    </filter>

    <!-- Enable A/P Heading Hold if one of the A/P heading modes has
         been selected.
    -->
    <logic>
        <name>A/P Heading On/Off Switcher</name>
        <input>
            <or>
                <equals>
                    <property>/autopilot/locks/heading</property>
                    <value>dg-heading-hold</value>
                </equals>
                <property>/v22/afcs/active/wypt-hold</property>
                <property>/v22/afcs/active/loc-hold</property>
                <property>/v22/afcs/active/tacan-hold</property>
            </or>
        </input>
        <output>
            <property>/v22/afcs/active/heading-hold</property>
        </output>
    </logic>

    <pi-simple-controller>
        <name>A/P NAV1 CDI Integrator</name>
        <enable>
            <property>/v22/afcs/active/loc-hold</property>
        </enable>
        <input>
            <property>/instrumentation/nav[0]/heading-needle-deflection-norm</property>
        </input>
        <reference>
            <value>0</value>
        </reference>
        <output>
            <property>/v22/afcs/internal/course-error-deg</property>
        </output>
        <config>
            <Kp>45.0</Kp>
            <Ki>0.40</Ki>
            <u_min>
                <property>/v22/afcs/settings/intercept-deg-max</property>
                <scale>-1.0</scale>
            </u_min>
            <u_max>
                <property>/v22/afcs/settings/intercept-deg-max</property>
            </u_max>
        </config>
    </pi-simple-controller>

    <filter>
        <name>A/P NAV1 Localizer/VOR Intercept Heading Computer</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <property>/v22/afcs/active/loc-hold</property>
        </enable>
        <input>
            <condition>
                <not-equals>
                    <property>/instrumentation/nav[0]/loc/ident</property>
                    <value></value>
                </not-equals>
            </condition>
            <property>/instrumentation/nav[0]/loc/true-bearing-to-deg</property>
            <offset>
                <property>/environment/magnetic-variation-deg</property>
                <scale>-1.0</scale>
            </offset>
        </input>
        <input>
            <property>/instrumentation/nav[0]/radials/selected-deg</property>
        </input>
        <reference>
            <property>/v22/afcs/internal/course-error-deg</property>
        </reference>
        <output>
            <property>/v22/afcs/target/intercept-heading</property>
        </output>
        <period>
            <min>0</min>
            <max>360</max>
        </period>
    </filter>

    <!-- Computes the heading bug error relative to magnetic intercept
         heading of the NAV1 localizer.
    -->
    <filter>
        <name>A/P NAV1 Localizer Heading Bug Error Computer</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <property>/v22/afcs/active/loc-hold</property>
        </enable>
        <input>
            <property>/v22/afcs/target/intercept-heading</property>
        </input>
        <reference>
            <property>/instrumentation/gps/indicated-track-magnetic-deg</property>
        </reference>
        <output>
            <property>/v22/afcs/internal/heading-bug-error-deg</property>
        </output>
        <period>
            <min>-180</min>
            <max>180</max>
        </period>
    </filter>

    <!-- A filter which remembers the last true track when the aircraft
         gets too close to the TACAN target. As long as TACAN is enabled
         and the distance to the target is greater than a certain distance,
         it will update the tacan-true-heading-deg property. Once the
         aircraft gets too close, it will stop updating the property,
         causing the aircraft to maintain the remembered track.
    -->
    <filter>
        <name>A/P TACAN Track Store</name>
        <update-interval-secs type="double">0.1</update-interval-secs>
        <type>gain</type>
        <enable>
            <condition>
                <and>
                    <property>/v22/afcs/active/tacan-hold</property>
                    <greater-than>
                        <property>/instrumentation/tacan/indicated-distance-nm</property>
                        <value>0.2</value>
                    </greater-than>
                </and>
            </condition>
        </enable>
        <input>
            <property>/instrumentation/gps/indicated-track-true-deg</property>
        </input>
        <output>
            <property>/v22/afcs/target/tacan-true-heading-deg</property>
        </output>
    </filter>

    <filter>
        <name>A/P TACAN Heading Bug Error Computer</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <property>/v22/afcs/active/tacan-hold</property>
        </enable>
        <input>
            <condition>
                <greater-than>
                    <property>/instrumentation/tacan/indicated-distance-nm</property>
                    <value>0.2</value>
                </greater-than>
            </condition>
            <property>/instrumentation/tacan/indicated-bearing-true-deg</property>
        </input>
        <input>
            <!-- Maintain the remembered track -->
            <property>/v22/afcs/target/tacan-true-heading-deg</property>
        </input>
        <reference>
            <property>/instrumentation/gps/indicated-track-true-deg</property>
        </reference>
        <output>
            <property>/v22/afcs/internal/heading-bug-error-deg</property>
        </output>
        <period>
            <min>-180</min>
            <max>180</max>
        </period>
    </filter>

    <!-- A filter to compute the Kp that is used by the A/P Heading Hold
         PI controller. While APLN mode can safely use a large value to
         get a quick response, for VTOL mode a value very close to zero
         needs to be used to prevent oscillations.
    -->
    <filter>
        <name>A/P Heading Hold Kp Computer</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <expression>
                <table>
                    <property>/sim/model/v22/tilt</property>
                    <entry><ind>15</ind><dep>-0.15</dep></entry>
                    <entry><ind>90</ind><dep>-1.75</dep></entry>
                </table>
            </expression>
        </input>
        <output>
            <property>/v22/afcs/internal/heading-kp</property>
        </output>
    </filter>

    <!-- A filter to compute the maximum roll degree allowed
         by the A/P Heading Hold controller. If the airspeed is
         very low, the aircraft will be in VTOL mode and rolling
         too much will result in losing too much altitude.
    -->
    <filter>
        <name>A/P Maximum Heading Roll Hold Computer</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <expression>
                <table>
                    <property>/velocities/airspeed-kt</property>
                    <entry><ind>40</ind><dep>10</dep></entry>
                    <entry><ind>80</ind><dep>25</dep></entry>
                </table>
            </expression>
        </input>
        <output>
            <property>/v22/afcs/internal/maximum-heading-roll-deg</property>
        </output>
        <max>
            <property>/v22/pfcs/target/roll-hold-limit</property>
        </max>
    </filter>

    <!-- Tracks a given magnetic heading or GPS track. By using the
         computed heading bug error relative to the given heading, the
         A/P will turn the aircraft left or right depending on which
         turn is the shortest.
    -->
    <pi-simple-controller>
        <name>A/P Heading Hold</name>
        <debug>false</debug>
        <enable>
            <property>/v22/afcs/active/heading-hold</property>
        </enable>
        <input>
            <property>/v22/afcs/internal/heading-bug-error-deg</property>
        </input>
        <reference>
            <value>0</value>
        </reference>
        <output>
            <property>/v22/pfcs/target/roll-deg</property>
        </output>
        <config>
            <Kp>
                <property>/v22/afcs/internal/heading-kp</property>
            </Kp>
            <Ki>0.0</Ki>
            <u_min>
                <property>/v22/afcs/internal/maximum-heading-roll-deg</property>
                <scale>-1.0</scale>
            </u_min>
            <u_max>
                <property>/v22/afcs/internal/maximum-heading-roll-deg</property>
            </u_max>
        </config>
    </pi-simple-controller>

    <!-- Enable FBW Roll Hold if one of the A/P Roll Axis modes
         are enabled.
    -->
    <logic>
        <name>A/P Roll Axis Modes Dependency FBW Roll Hold</name>
        <input>
            <or>
                <equals>
                    <property>/autopilot/locks/heading</property>
                    <value>wing-leveler</value>
                </equals>
                <property>/v22/afcs/active/heading-hold</property>
            </or>
        </input>
        <output>
            <property>/v22/pfcs/active/roll-hold</property>
        </output>
    </logic>

    <!-- ================================================================== -->
    <!-- Pitch Axis Modes                                                   -->
    <!-- ================================================================== -->

    <logic>
        <name>A/P Pitch Hold On/Off Switcher</name>
        <input>
            <and>
                <equals>
                    <property>/autopilot/locks/altitude</property>
                    <value>pitch-hold</value>
                </equals>
                <not>
                    <property>/v22/afcs/active/gs-hold</property>
                </not>
            </and>
        </input>
        <output>
            <property>/v22/afcs/active/pitch-hold-no-gs</property>
        </output>
    </logic>

    <filter>
        <name>A/P Pitch Hold</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <property>/v22/afcs/active/pitch-hold-no-gs</property>
        </enable>
        <input>
            <property>/autopilot/settings/target-pitch-deg</property>
        </input>
        <output>
            <property>/v22/pfcs/target/pitch-deg</property>
        </output>
    </filter>

    <!-- A filter to compute the Kp that is used by the A/P Altitude Hold
         and A/P Altitude AGL Hold PI controllers.
    -->
    <filter>
        <name>A/P Altitude Hold Kp Computer</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <expression>
                <table>
                    <property>/sim/model/v22/tilt</property>
                    <entry><ind>15</ind><dep>0.97</dep></entry>
                    <entry><ind>90</ind><dep>0.35</dep></entry>
                </table>
            </expression>
        </input>
        <output>
            <property>/v22/afcs/internal/altitude-kp</property>
        </output>
    </filter>

    <!-- A filter to compute the Ki that is used by the A/P Altitude Hold
         and A/P Altitude AGL Hold PI controllers.
    -->
    <filter>
        <name>A/P Altitude Hold Ki Computer</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <expression>
                <table>
                    <property>/sim/model/v22/tilt</property>
                    <entry><ind>15</ind><dep>0.027</dep></entry>
                    <entry><ind>90</ind><dep>0.01</dep></entry>
                </table>
            </expression>
        </input>
        <output>
            <property>/v22/afcs/internal/altitude-ki</property>
        </output>
    </filter>

    <!-- Tracks a given altitude -->
    <pi-simple-controller>
        <name>A/P Altitude Hold</name>
        <debug>false</debug>
        <enable>
            <condition>
                <and>
                    <equals>
                        <property>/autopilot/locks/altitude</property>
                        <value>altitude-hold</value>
                    </equals>
                    <not>
                        <property>/v22/afcs/active/gs-hold</property>
                    </not>
                </and>
            </condition>
        </enable>
        <input>
            <property>/instrumentation/altimeter/indicated-altitude-ft</property>
        </input>
        <reference>
            <property>/v22/afcs/target/ap-altitude-ft</property>
        </reference>
        <output>
            <property>/v22/afcs/target/vs-fps</property>
        </output>
        <config>
            <!-- TODO Perhaps use a pid-controller so we can better damp the response -->
            <Kp>
                <property>/v22/afcs/internal/altitude-kp</property>
            </Kp>
            <Ki>
                <property>/v22/afcs/internal/altitude-ki</property>
            </Ki>
            <u_min>
                <property>/v22/afcs/settings/climb-rate-max</property> 

                <!-- Multiply by 1/60 to convert from fpm to fps -->
                <scale>-0.01666666</scale>
            </u_min>
            <u_max>
                <property>/v22/afcs/settings/climb-rate-max</property> 

                <!-- Multiply by 1/60 to convert from fpm to fps -->
                <scale>0.01666666</scale>
            </u_max>
        </config>
    </pi-simple-controller>

    <!-- Set active/hvr-alt-hold-became-true to true if HVR ALT A/P got
         enabled in the "Autopilot Panel" window and the groundspeed is
         less than 55 knots.

         The property is set back to false in the same iteration of the
         FDM by the <logic> element below. This is to prevent re-enabling
         the HVR ALT A/P when it gets disabled by the RS flipflop when
         the groundspeed becomes higher than 55 knots.

         In order to re-enable the HVR ALT A/P, the pilot first needs to
         disable it in the "Autopilot Panel" window and then re-enable
         it again. This will trigger the raising edge of the clock.
    -->
    <flipflop>
        <name>A/P HVR ALT Became True</name>
        <update-interval-secs type="double">0.1</update-interval-secs>
        <type>D</type>
        <D>
            <less-than-equals>
                <property>/velocities/groundspeed-kt</property>
                <value>55.0</value>
            </less-than-equals>
        </D>
        <clock>
            <equals>
                <property>/autopilot/locks/altitude</property>
                <value>agl-hold</value>
            </equals>
        </clock>
        <output>
            <property>/v22/afcs/active/hvr-alt-hold-became-true</property>
        </output>
    </flipflop>

    <!-- Set the HVR ALT A/P if the pilot enables it in the "Autopilot Panel"
         window while the groundspeed is less than 55 knots. Disable it
         if the pilot disables it or if the groundspeed becomes higher than
         55 knots. Once it has been disabled, the pilot first needs to
         disable it in the "Autopilot Panel" window in order to re-enable it
         again.
    -->
    <flipflop>
        <name>A/P HVR ALT On/Off Switcher</name>
        <update-interval-secs type="double">0.1</update-interval-secs>
        <type>RS</type>
        <S>
            <property>/v22/afcs/active/hvr-alt-hold-became-true</property>
        </S>
        <R>
            <or>
                <not-equals>
                    <property>/autopilot/locks/altitude</property>
                    <value>agl-hold</value>
                </not-equals>
                <greater-than>
                    <property>/velocities/groundspeed-kt</property>
                    <value>55.0</value>
                </greater-than>
            </or>
        </R>
        <output>
            <property>/v22/afcs/active/hvr-alt-hold</property>
        </output>
    </flipflop>

    <!-- Reset the active/hvr-alt-hold-became-true property in order to
         prevent re-enabling the HVR ALT A/P when it gets disabled by the
         RS flipflop when the groundspeed becomes higher than 55 knots.
    -->
    <logic>
        <name>A/P HVR ALT Reset Set Line</name>
        <update-interval-secs type="double">0.1</update-interval-secs>
        <enable>
            <property>/v22/afcs/active/hvr-alt-hold</property>
        </enable>
        <input>
            <false/>
        </input>
        <output>
            <property>/v22/afcs/active/hvr-alt-hold-became-true</property>
        </output>
    </logic>

    <!-- Tracks a given altitude above ground level -->
    <pi-simple-controller>
        <name>A/P Altitude AGL Hold</name>
        <debug>false</debug>
        <enable>
            <condition>
                <and>
                    <property>/v22/afcs/active/hvr-alt-hold</property>
                    <not>
                        <property>/v22/afcs/active/gs-hold</property>
                    </not>
                </and>
            </condition>
        </enable>
        <input>
            <property>/position/gear-agl-ft</property>
        </input>
        <reference>
            <property>/v22/afcs/target/ap-agl-ft</property>
        </reference>
        <output>
            <property>/v22/afcs/target/vs-fps</property>
        </output>
        <config>
            <Kp>
                <property>/v22/afcs/internal/altitude-kp</property>
            </Kp>
            <Ki>
                <property>/v22/afcs/internal/altitude-ki</property>
            </Ki>
            <u_min>
                <property>/v22/afcs/settings/climb-rate-max</property> 

                <!-- Multiply by 1/60 to convert from fpm to fps -->
                <scale>-0.01666666</scale>
            </u_min>
            <u_max>
                <property>/v22/afcs/settings/climb-rate-max</property> 

                <!-- Multiply by 1/60 to convert from fpm to fps -->
                <scale>0.01666666</scale>
            </u_max>
        </config>
    </pi-simple-controller>

    <!-- Enable the 'localizer established' switch if the aircraft has
         established itself on the localizer for at least a certain
         (configurable) amount of time.

         This monostable flipflop is used so that the aircraft will not
         try to establish itself on the localizer _and_ the glideslope
         at the same time when the VOR/ILS mode is activated while
         within range of the glideslope.
    -->
    <flipflop>
        <name>A/P NAV1 Localizer Established On/Off Switcher</name>
        <type>monostable</type>
        <inverted type="bool">true</inverted>
        <enable>
            <property>/v22/afcs/active/loc-hold</property>
        </enable>
        <S>
            <or>
                <greater-than>
                    <expression>
                        <abs>
                            <property>/v22/afcs/internal/course-error-deg</property>
                        </abs>
                    </expression>
                    <value>5.0</value>
                </greater-than>
                <greater-than>
                    <expression>
                        <abs>
                            <property>/v22/afcs/internal/heading-bug-error-deg</property>
                        </abs>
                    </expression>
                    <value>5.0</value>
                </greater-than>
            </or>
        </S>
        <time>
            <property>/v22/afcs/settings/loc-established-s</property>
        </time>
        <output>
            <property>/v22/afcs/active/loc-established</property>
        </output>
    </flipflop>

    <!-- Enable A/P NAV1 Glideslope if glideslope is in range and NAV1
         mode selected in A/P.
    -->
    <logic>
        <name>A/P NAV1 Glideslope On/Off Switcher</name>
        <input>
            <and>
                <property>/v22/afcs/active/loc-hold</property>
                <property>/v22/afcs/active/loc-established</property>
                <property>/instrumentation/nav[0]/has-gs</property>
                <property>/instrumentation/nav[0]/gs/in-range</property>
                <greater-than>
                    <property>/instrumentation/nav[0]/gs/signal-quality-norm</property>
                    <value>0.85</value>
                </greater-than>
                <or>
                    <!-- The glideslope should only be captured when the
                         aircraft is very close to the center of the signal.
                    -->
                    <less-than>
                        <expression>
                            <abs>
                                <property>/instrumentation/nav[0]/gs-needle-deflection-norm</property>
                            </abs>
                        </expression>
                        <value>0.5</value>
                    </less-than>

                    <!-- Once the glideslope was captured, this filter
                         should not be switched off as long as the
                         aircraft keeps flying within the full width
                         of the glideslope.
                    -->
                    <and>
                        <property>/v22/afcs/active/gs-hold</property>

                        <less-than>
                            <expression>
                                <abs>
                                    <property>/instrumentation/nav[0]/gs-needle-deflection-norm</property>
                                </abs>
                            </expression>
                            <value>1.0</value>
                        </less-than>
                    </and>
                </or>
            </and>
        </input>
        <output>
            <property>/v22/afcs/active/gs-hold</property>
        </output>
    </logic>

    <!-- Tracks the glideslope of the current NAV1 signal -->
    <pid-controller>
        <name>A/P NAV1 Glideslope</name>
        <debug>false</debug>
        <enable>
            <property>/v22/afcs/active/gs-hold</property>
        </enable>
        <input>
            <property>/instrumentation/nav[0]/gs-needle-deflection-norm</property>
        </input>
        <reference>
            <value>0</value>
        </reference>
        <output>
            <property>/v22/afcs/target/vs-fps</property>
        </output>
        <config>
            <Kp>-120.0</Kp>
            <Ti>28.0</Ti>
            <Td>0.0</Td>
            <u_min>-20.0</u_min>
            <u_max>10.0</u_max>
        </config>
    </pid-controller>

    <!-- Tracks the vertical speed (in fpm) set in the A/P -->
    <filter>
        <name>A/P V/S Hold</name>
        <type>gain</type>

        <!-- Multiply by 1/60 to convert from fpm to fps -->
        <gain>0.01666666</gain>

        <enable>
            <condition>
                <equals>
                    <property>/autopilot/locks/altitude</property>
                    <value>vertical-speed-hold</value>
                </equals>
                <not>
                    <property>/v22/afcs/active/gs-hold</property>
                </not>
            </condition>
        </enable>
        <input>
            <property>/autopilot/settings/vertical-speed-fpm</property>
        </input>
        <output>
            <property>/v22/afcs/target/vs-fps</property>
        </output>
    </filter>

    <logic>
        <name>A/P Vertical Speed On/Off Switcher</name>
        <input>
            <or>
                <equals>
                    <property>/autopilot/locks/altitude</property>
                    <value>vertical-speed-hold</value>
                </equals>
                <equals>
                    <property>/autopilot/locks/altitude</property>
                    <value>altitude-hold</value>
                </equals>
                <property>/v22/afcs/active/hvr-alt-hold</property>
                <property>/v22/afcs/active/gs-hold</property>
            </or>
        </input>
        <output>
            <property>/v22/afcs/active/vs-hold</property>
        </output>
    </logic>

    <!-- Tracks a given vertical speed (in fps), set by the pilot
         or by the NAV1 glideslope signal, by controlling the
         pitch of the aircraft. Used when the nacelles have tilted
         to a horizontal position.
    -->
    <pid-controller>
        <name>A/P Vertical Speed APLN Hold</name>
        <debug>false</debug>
        <enable>
            <property>/v22/afcs/active/vs-hold</property>
        </enable>
        <input>
            <property>/velocities/vertical-speed-fps</property>
        </input>
        <reference>
            <property>/v22/afcs/target/vs-fps</property>
        </reference>
        <output>
            <property>/v22/afcs/target/pitch-deg-apln</property>
        </output>
        <config>
            <Kp>0.52</Kp>
            <Ti>3.0</Ti>
            <Td>0.0</Td>
            <u_min>
                <property>/v22/pfcs/settings/pitch-hold-min</property>
            </u_min>
            <u_max>
                <condition>
                    <property>/v22/afcs/active/gs-hold</property>
                </condition>
                <property>/v22/afcs/settings/gs-hold-pitch-max</property>
                <max>
                    <property>/v22/pfcs/settings/pitch-hold-max</property>
                </max>
            </u_max>
            <u_max>
                <property>/v22/pfcs/settings/pitch-hold-max</property>
            </u_max>
        </config>
    </pid-controller>

    <!-- Computes the maximum rate of descent for VTOL mode to prevent
         vortex ring state. If  the incidence of the nacelles is greater
         than 80 degrees (lower than 10 degrees for YASim) then the V/S
         is restricted to -800 fpm. This filter implements the updated NATOPS
         limit [1].
    -->
    <filter>
        <name>Vortex Ring State Maximum Rate Of Descent Computer</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <expression>
                <table>
                    <property>/instrumentation/airspeed-indicator/true-speed-kt</property>
                    <entry><ind>40</ind><dep>-800</dep></entry>
                    <entry><ind>200</ind><dep>-4000</dep></entry>
                </table>
            </expression>
        </input>
        <output>
            <property>/v22/afcs/internal/vrs-maximum-descent-rate-fpm</property>
        </output>
        <min>
            <condition>
                <less-than-equals>
                    <property>/sim/model/v22/tilt</property>
                    <value>10.0</value>
                </less-than-equals>
            </condition>
            <value>-800</value>
        </min>

        <!-- Even though the table already limits the output to -4000,
             without this <min> element the output will become 0 if the
             conditional <min> (see above) does not apply.
        -->
        <min>-4000</min>
    </filter>

    <filter>
        <name>A/P Maximum Rate Of Descent VTOL Computer</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <property>/v22/afcs/internal/vrs-maximum-descent-rate-fpm</property>
        </input>
        <output>
            <property>/v22/afcs/internal/maximum-descent-rate-vtol-fpm</property>
        </output>
        <min>
            <property>/v22/afcs/settings/climb-rate-max</property> 
            <scale>-1.0</scale>
        </min>
    </filter>

    <filter>
        <name>A/P V/S VTOL Limiter</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <property>/v22/afcs/target/vs-fps</property>
            <min>
                <property>/v22/afcs/internal/maximum-descent-rate-vtol-fpm</property>

                <!-- Multiply by 1/60 to convert from fpm to fps -->
                <scale>0.01666666</scale>
            </min>
        </input>
        <output>
            <property>/v22/afcs/target/vs-fps-vtol-filtered</property>
        </output>
    </filter>

    <!-- Tracks a given vertical speed (in fps), set by the pilot
         or by the NAV1 glideslope signal, by controlling the
         throttle of the engines. Used when the nacelles have tilted
         to a vertical position.
    -->
    <pid-controller>
        <name>A/P Vertical Speed VTOL Hold</name>
        <debug>false</debug>
        <enable>
            <condition>
                <and>
                    <property>/v22/afcs/active/vs-hold</property>
                    <equals>
                        <property>/controls/engines/engine/magnetos</property>
                        <value>1.0</value>
                    </equals>
                </and>
            </condition>
        </enable>
        <input>
            <property>/velocities/vertical-speed-fps</property>
        </input>
        <reference>
            <property>/v22/afcs/target/vs-fps-vtol-filtered</property>
        </reference>
        <output>
            <property>/v22/afcs/target/throttle-vtol</property>
        </output>
        <config>
            <Kp>
                <condition>
                    <greater-than>
                        <property>/velocities/vertical-speed-fps</property>
                        <property>/v22/afcs/target/vs-fps-vtol-filtered</property>
                    </greater-than>
                </condition>
                <value>0.02</value>
            </Kp>
            <Kp>0.02</Kp>
            <Ti>
                <condition>
                    <greater-than>
                        <property>/velocities/vertical-speed-fps</property>
                        <property>/v22/afcs/target/vs-fps-vtol-filtered</property>
                    </greater-than>
                </condition>
                <value>6.1</value>
            </Ti>
            <Ti>2.0</Ti>
            <Td>0.0</Td>
            <u_min>0.125</u_min>
            <u_max>1.0</u_max>
        </config>
    </pid-controller>

    <!-- Enable FBW Pitch Hold if A/P Pitch Hold or A/P VS Hold is
         enabled.
    -->
    <logic>
        <name>A/P Pitch Hold and Vertical Speed Hold Dependency FBW Pitch Hold</name>
        <input>
            <or>
                <equals>
                    <property>/autopilot/locks/altitude</property>
                    <value>pitch-hold</value>
                </equals>
                <property>/v22/afcs/active/vs-hold</property>
                <property>/v22/afcs/active/spd-hold</property>
            </or>
        </input>
        <output>
            <property>/v22/pfcs/active/pitch-hold</property>
        </output>
    </logic>

    <!-- ================================================================== -->
    <!-- Throttle Modes                                                     -->
    <!-- ================================================================== -->

    <logic>
        <name>A/P Horizontal Speed Hold On/Off Switcher</name>
        <input>
            <equals>
                <property>/autopilot/locks/speed</property>
                <value>speed-with-throttle</value>
            </equals>
        </input>
        <output>
            <property>/v22/afcs/active/spd-hold</property>
        </output>
    </logic>

    <!-- Tracks a given horizontal speed (in knots), set by the pilot,
         by controlling the throttle of the engines. Used when the
         nacelles have tilted to a horizontal position.
    -->
    <pid-controller>
        <name>A/P Horizontal Speed APLN Hold</name>
        <debug>false</debug>
        <enable>
            <condition>
                <and>
                    <property>/v22/afcs/active/spd-hold</property>
                    <equals>
                        <property>/controls/engines/engine/magnetos</property>
                        <value>1.0</value>
                    </equals>
                </and>
            </condition>
        </enable>
        <input>
            <property>/instrumentation/airspeed-indicator/indicated-speed-kt</property>
        </input>
        <reference>
            <property>/autopilot/settings/target-speed-kt</property>
        </reference>
        <output>
            <property>/v22/afcs/target/throttle-apln</property>
        </output>
        <config>
            <Kp>
                <condition>
                    <greater-than>
                        <property>/instrumentation/airspeed-indicator/indicated-speed-kt</property>
                        <property>/autopilot/settings/target-speed-kt</property>
                    </greater-than>
                </condition>
                <value>0.02</value>
            </Kp>
            <Kp>0.02</Kp>
            <Ti>
                <condition>
                    <greater-than>
                        <property>/instrumentation/airspeed-indicator/indicated-speed-kt</property>
                        <property>/autopilot/settings/target-speed-kt</property>
                    </greater-than>
                </condition>
                <value>6.1</value>
            </Ti>
            <Ti>2.0</Ti>
            <Td>0.0</Td>
            <u_min>0.125</u_min>
            <u_max>1.0</u_max>
        </config>
    </pid-controller>

    <!-- Tracks a given horizontal speed (in knots), set by the pilot,
         by controlling the pitch of the aircraft. Used when the
         nacelles have tilted to a vertical position.

         The allowed pitch is severely restricted in order to avoid
         losing too much altitude.
    -->
    <pid-controller>
        <name>A/P Horizontal Speed VTOL Hold</name>
        <debug>false</debug>
        <enable>
            <property>/v22/afcs/active/spd-hold</property>
        </enable>
        <input>
            <property>/instrumentation/airspeed-indicator/indicated-speed-kt</property>
        </input>
        <reference>
            <property>/autopilot/settings/target-speed-kt</property>
        </reference>
        <output>
            <property>/v22/afcs/target/pitch-deg-vtol</property>
        </output>
        <config>
            <Kp>-0.52</Kp>
            <Ti>3.0</Ti>
            <Td>0.0</Td>
            <u_min>
                <property>/v22/afcs/settings/vtol-pitch-hold-min</property>
            </u_min>
            <u_max>
                <condition>
                    <property>/v22/afcs/active/gs-hold</property>
                </condition>
                <property>/v22/afcs/settings/gs-hold-pitch-max</property>
                <max>
                    <property>/v22/afcs/settings/vtol-pitch-hold-max</property>
                </max>
            </u_max>
            <u_max>
                <property>/v22/afcs/settings/vtol-pitch-hold-max</property>
            </u_max>
        </config>
    </pid-controller>

    <!-- ================================================================== -->
    <!-- V/S And Horizontal Speed Merge Filters                             -->
    <!-- ================================================================== -->

    <!-- Let A/P control pitch if Vertical Speed mode is active by
         routing pitch-deg-apln signal to pitch-deg.

         The PFCS will merge this with the stick input depending
         on the tilt of the nacelles.
    -->
    <filter>
        <name>A/P Vertical Speed APLN To Pitch Deg</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <condition>
                <and>
                    <property>/v22/afcs/active/vs-hold</property>
                    <not>
                        <property>/v22/afcs/active/spd-hold</property>
                    </not>
                </and>
            </condition>
        </enable>
        <input>
            <property>/v22/afcs/target/pitch-deg-apln</property>
        </input>
        <output>
            <property>/v22/pfcs/target/pitch-deg</property>
        </output>
    </filter>

    <!-- Let A/P control pitch if Horizontal Speed mode is active by
         routing pitch-deg-vtol signal to pitch-deg.

         The PFCS will merge this with the stick input depending
         on the tilt of the nacelles.
    -->
    <filter>
        <name>A/P Horizontal Speed VTOL To Pitch Deg</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <condition>
                <and>
                    <property>/v22/afcs/active/spd-hold</property>
                    <not>
                        <property>/v22/afcs/active/vs-hold</property>
                    </not>
                </and>
            </condition>
        </enable>
        <input>
            <property>/v22/afcs/target/pitch-deg-vtol</property>
        </input>
        <output>
            <property>/v22/pfcs/target/pitch-deg</property>
        </output>
    </filter>

    <!-- Merge pitch-deg-apln and pitch-deg-vtol depending on the tilt
         of the nacelles and route it to pitch-deg.

         The PFCS will ignore the stick input and will not merge it with
         pitch-deg.
    -->
    <filter>
        <name>A/P Vertical Speed APLN And Horizontal Speed VTOL Merge To Pitch Deg</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <condition>
                <and>
                    <property>/v22/afcs/active/vs-hold</property>
                    <property>/v22/afcs/active/spd-hold</property>
                </and>
            </condition>
        </enable>
        <input>
            <expression>
                <sum>
                    <product>
                        <property>/v22/afcs/target/pitch-deg-vtol</property>
                        <property>/v22/pfcs/internal/lst-tilt</property>
                    </product>
                    <product>
                        <property>/v22/afcs/target/pitch-deg-apln</property>
                        <difference>
                            <value>1.0</value>
                            <property>/v22/pfcs/internal/lst-tilt</property>
                        </difference>
                    </product>
                </sum>
            </expression>
        </input>
        <output>
            <property>/v22/pfcs/target/pitch-deg</property>
        </output>
    </filter>

    <filter>
        <name>A/P Vertical Speed VTOL To TCL</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <condition>
                <and>
                    <property>/v22/afcs/active/vs-hold</property>
                    <not>
                        <property>/v22/afcs/active/spd-hold</property>
                    </not>
                </and>
            </condition>
        </enable>
        <input>
            <expression>
                <sum>
                    <product>
                        <property>/v22/afcs/target/throttle-vtol</property>
                        <property>/v22/pfcs/internal/lst-tilt</property>
                    </product>
                    <product>
                        <property>/controls/engines/engine[0]/throttle</property>
                        <difference>
                            <value>1.0</value>
                            <property>/v22/pfcs/internal/lst-tilt</property>
                        </difference>
                    </product>
                </sum>
            </expression>
        </input>
        <output>
            <property>/v22/afcs/output/throttle</property>
        </output>
    </filter>

    <filter>
        <name>A/P Horizontal Speed APLN To TCL</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <condition>
                <and>
                    <property>/v22/afcs/active/spd-hold</property>
                    <not>
                        <property>/v22/afcs/active/vs-hold</property>
                    </not>
                </and>
            </condition>
        </enable>
        <input>
            <expression>
                <sum>
                    <product>
                        <property>/controls/engines/engine[0]/throttle</property>
                        <property>/v22/pfcs/internal/lst-tilt</property>
                    </product>
                    <product>
                        <property>/v22/afcs/target/throttle-apln</property>
                        <difference>
                            <value>1.0</value>
                            <property>/v22/pfcs/internal/lst-tilt</property>
                        </difference>
                    </product>
                </sum>
            </expression>
        </input>
        <output>
            <property>/v22/afcs/output/throttle</property>
        </output>
    </filter>

    <filter>
        <name>A/P Horizontal Speed APLN And Vertical Speed VTOL Merge To TCL</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <condition>
                <and>
                    <property>/v22/afcs/active/vs-hold</property>
                    <property>/v22/afcs/active/spd-hold</property>
                </and>
            </condition>
        </enable>
        <input>
            <expression>
                <sum>
                    <product>
                        <property>/v22/afcs/target/throttle-vtol</property>
                        <property>/v22/pfcs/internal/lst-tilt</property>
                    </product>
                    <product>
                        <property>/v22/afcs/target/throttle-apln</property>
                        <difference>
                            <value>1.0</value>
                            <property>/v22/pfcs/internal/lst-tilt</property>
                        </difference>
                    </product>
                </sum>
            </expression>
        </input>
        <output>
            <property>/v22/afcs/output/throttle</property>
        </output>
    </filter>

    <filter>
        <name>A/P Throttle Pilot To TCL</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <condition>
                <and>
                    <not>
                        <property>/v22/afcs/active/vs-hold</property>
                    </not>
                    <not>
                        <property>/v22/afcs/active/spd-hold</property>
                    </not>
                </and>
            </condition>
        </enable>
        <input>
            <property>/controls/engines/engine[0]/throttle</property>
        </input>
        <output>
            <property>/v22/afcs/output/throttle</property>
        </output>
    </filter>

    <!-- ================================================================== -->
    <!-- Automatic Nacelles Tilting Modes                                   -->
    <!-- ================================================================== -->

    <filter>
        <name>Auto Nacelles Speed Tilt</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <expression>
                <table>
                    <property>/velocities/airspeed-kt</property>
                    <entry><ind>200</ind><dep>90.00</dep></entry>
                    <entry><ind>195</ind><dep>78.30</dep></entry>
                    <entry><ind>190</ind><dep>69.10</dep></entry>
                    <entry><ind>185</ind><dep>60.50</dep></entry>
                    <entry><ind>180</ind><dep>57.14</dep></entry>
                    <entry><ind>175</ind><dep>54.12</dep></entry>
                    <entry><ind>170</ind><dep>51.24</dep></entry>
                    <entry><ind>165</ind><dep>48.28</dep></entry>
                    <entry><ind>160</ind><dep>45.31</dep></entry>
                    <entry><ind>155</ind><dep>42.39</dep></entry>
                    <entry><ind>150</ind><dep>40.89</dep></entry>
                    <entry><ind>145</ind><dep>39.39</dep></entry>
                    <entry><ind>140</ind><dep>37.89</dep></entry>
                    <entry><ind>135</ind><dep>36.89</dep></entry>
                    <entry><ind>130</ind><dep>34.89</dep></entry>
                    <entry><ind>125</ind><dep>33.39</dep></entry>
                    <entry><ind>120</ind><dep>31.89</dep></entry>
                    <entry><ind>115</ind><dep>30.39</dep></entry>
                    <entry><ind>110</ind><dep>28.89</dep></entry>
                    <entry><ind>105</ind><dep>27.39</dep></entry>
                    <entry><ind>100</ind><dep>25.89</dep></entry>
                    <entry><ind>095</ind><dep>24.39</dep></entry>
                    <entry><ind>090</ind><dep>23.85</dep></entry>
                    <entry><ind>085</ind><dep>23.14</dep></entry>
                    <entry><ind>080</ind><dep>22.51</dep></entry>
                    <entry><ind>075</ind><dep>22.46</dep></entry>
                    <entry><ind>070</ind><dep>21.26</dep></entry>
                    <entry><ind>065</ind><dep>19.71</dep></entry>
                    <entry><ind>060</ind><dep>18.05</dep></entry>
                    <entry><ind>055</ind><dep>16.22</dep></entry>
                    <entry><ind>050</ind><dep>14.26</dep></entry>
                    <entry><ind>045</ind><dep>12.25</dep></entry>
                    <entry><ind>040</ind><dep>10.31</dep></entry>
                    <entry><ind>035</ind><dep>08.84</dep></entry>
                    <entry><ind>030</ind><dep>06.77</dep></entry>
                    <entry><ind>025</ind><dep>04.29</dep></entry>
                    <entry><ind>020</ind><dep>00.43</dep></entry>
                    <entry><ind>015</ind><dep>-01.48</dep></entry>
                    <entry><ind>010</ind><dep>-02.03</dep></entry>
                </table>
            </expression>
        </input>
        <output>
            <property>/v22/afcs/target/auto-nac-tilt</property>
        </output>
    </filter>

    <logic>
        <name>A/P Auto Nacelles On/Off Switcher</name>
        <input>
            <and>
                <property>/v22/afcs/active/spd-hold</property>
                <or>
                    <property>/v22/afcs/active/gs-hold</property>
                    <property>/v22/afcs/locks/auto-nac</property>
                </or>
            </and>
        </input>
        <output>
            <property>/v22/afcs/active/auto-nac</property>
        </output>
    </logic>

    <pi-simple-controller>
        <name>A/P Auto Nacelles Tilt</name>
        <debug>false</debug>
        <enable>
            <property>/v22/afcs/active/auto-nac</property>
        </enable>
        <input>
            <property>/v22/pfcs/output/tilt</property>
        </input>
        <reference>
            <property>/v22/afcs/target/auto-nac-tilt</property>
        </reference>
        <output>
            <property>/v22/pfcs/target/tilt-rate</property>
        </output>
        <config>
            <Kp>0.45</Kp>
            <Ki>0.0</Ki>
            <u_min>-2.0</u_min>
            <u_max> 2.0</u_max>
        </config>
    </pi-simple-controller>

    <!-- Set tilt-rate to 0 deg/s on the negative edge of auto-nac -->
    <flipflop>
        <name>Auto Nac Became Disabled</name>
        <update-interval-secs type="double">0.1</update-interval-secs>
        <type>D</type>
        <D>
            <false/>
        </D>
        <clock>
            <not>
                <property>/v22/afcs/active/auto-nac</property>
            </not>
        </clock>
        <output>
            <property>/v22/pfcs/target/tilt-rate</property>
        </output>
    </flipflop>

</PropertyList>
