<?xml version="1.0"?>

<PropertyList>

    <!-- ================================================================== -->
    <!-- Roll Axis Modes                                                    -->
    <!-- ================================================================== -->

    <!-- Filter which sets the desired roll angle to zero in order to
         level the wings.
    -->
    <filter>
        <name>A/P Wing Leveler</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <condition>
                <and>
                    <equals>
                        <property>/autopilot/locks/heading</property>
                        <value>wing-leveler</value>
                    </equals>
                    <property>/v22/pfcs/active/roll-axis-unconstrained</property>
                </and>
                <not>
                   <property>/v22/afcs/active/loc-hold</property>
                </not>
            </condition>
        </enable>
        <input>
            <value>0.0</value>
        </input>
        <output>
            <property>/v22/pfcs/target/roll-deg</property>
        </output>
    </filter>

    <!-- This filter computes the heading bug error relative to the
         magnetic heading set in the A/P. It is positive if the current
         magnetic heading of the aircraft is to the left of the requested
         heading and negative if the current heading is to the right.
    -->
    <filter>
        <name>A/P Magnetic Heading Bug Error Computer</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <condition>
                <equals>
                    <property>/autopilot/locks/heading</property>
                    <value>dg-heading-hold</value>
                </equals>
                <not>
                   <property>/v22/afcs/active/loc-hold</property>
                </not>
            </condition>
        </enable>
        <input>
            <property>/autopilot/settings/heading-bug-deg</property>
            <offset>
                <property>/orientation/heading-magnetic-deg</property>
                <scale>-1.0</scale>
            </offset>
        </input>
        <output>
            <property>/v22/afcs/internal/heading-bug-error-deg</property>
        </output>
        <period>
            <min>-180</min>
            <max>180</max>
        </period>
    </filter>

    <!-- Computes the GPS track heading bug error relative to the true 
         heading set in the A/P. This filter basically works the same
         way as the filter above using the magnetic heading.
    -->
    <filter>
        <name>A/P GPS Track True Heading Bug Error Computer</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <condition>
                <and>
                    <property>/autopilot/settings/gps-driving-true-heading</property>
                    <equals>
                        <property>/autopilot/locks/heading</property>
                        <value>true-heading-hold</value>
                    </equals>
                    <not>
                        <property>/v22/afcs/active/loc-hold</property>
                    </not>
                </and>
            </condition>
        </enable>
        <input>
            <property>/autopilot/settings/true-heading-deg</property>
            <offset>
                <property>/instrumentation/gps/indicated-track-true-deg</property>
                <scale>-1.0</scale>
            </offset>
        </input>
        <output>
            <property>/v22/afcs/internal/heading-bug-error-deg</property>
        </output>
        <period>
            <min>-180</min>
            <max>180</max>
        </period>
    </filter>

    <!-- Enable A/P NAV1 Localizer if localizer is in range and NAV1
         mode selected in A/P.
    -->
    <logic>
        <name>A/P NAV1 Localizer On/Off Switcher</name>
        <input>
            <and>
                <equals>
                    <property>/v22/afcs/locks/heading</property>
                    <value>nav1-hold</value>
                </equals>
                <property>/instrumentation/nav[0]/nav-loc</property>
                <property>/instrumentation/nav[0]/in-range</property>
                <greater-than>
                    <property>/instrumentation/nav[0]/signal-quality-norm</property>
                    <value>0.9</value>
                </greater-than>
            </and>
        </input>
        <output>
            <property>/v22/afcs/active/loc-hold</property>
        </output>
    </logic>

    <!-- Enable A/P Heading Hold if one of the A/P heading modes has
         been selected.
    -->
    <logic>
        <name>A/P Heading On/Off Switcher</name>
        <input>
            <or>
                <equals>
                    <property>/autopilot/locks/heading</property>
                    <value>dg-heading-hold</value>
                </equals>
                <and>
                    <property>/autopilot/settings/gps-driving-true-heading</property>
                    <equals>
                        <property>/autopilot/locks/heading</property>
                        <value>true-heading-hold</value>
                    </equals>
                </and>
                <property>/v22/afcs/active/loc-hold</property>
            </or>
        </input>
        <output>
            <property>/v22/afcs/active/heading-hold</property>
        </output>
    </logic>

    <!-- Computes the heading bug error relative to the true heading
         of the NAV1 localizer.
    -->
    <filter>
        <name>A/P NAV1 Localizer Heading Bug Error Computer</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <property>/v22/afcs/active/loc-hold</property>
        </enable>
        <input>
            <property>/instrumentation/nav[0]/radials/target-auto-hdg-deg</property>
            <offset>
                <property>/orientation/heading-deg</property>
                <scale>-1.0</scale>
            </offset>
        </input>
        <output>
            <property>/v22/afcs/internal/heading-bug-error-deg</property>
        </output>
        <period>
            <min>-180</min>
            <max>180</max>
        </period>
    </filter>

    <!-- A filter to compute the Kp that is used by the A/P Heading Hold
         PI controller. While APLN mode can safely use a large value to
         get a quick response, for VTOL mode a value very close to zero
         needs to be used to prevent oscillations.
    -->
    <filter>
        <name>A/P Heading Hold Kp Computer</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <expression>
                <table>
                    <property>/sim/model/v22/tilt</property>
                    <entry><ind>15</ind><dep>-0.15</dep></entry>
                    <entry><ind>90</ind><dep>-1.75</dep></entry>
                </table>
            </expression>
        </input>
        <output>
            <property>/v22/afcs/internal/heading-kp</property>
        </output>
    </filter>

    <!-- A filter to compute the maximum roll degree allowed
         by the A/P Heading Hold controller. If the airspeed is
         very low, the aircraft will be in VTOL mode and rolling
         too much will result in losing too much altitude.
    -->
    <filter>
        <name>A/P Maximum Heading Roll Hold Computer</name>
        <type>gain</type>
        <gain>1.0</gain>
        <input>
            <expression>
                <table>
                    <property>/velocities/airspeed-kt</property>
                    <entry><ind>40</ind><dep>10</dep></entry>
                    <entry><ind>80</ind><dep>25</dep></entry>
                    <entry><ind>110</ind><dep>45</dep></entry>
                </table>
            </expression>
        </input>
        <output>
            <property>/v22/afcs/internal/maximum-heading-roll-deg</property>
        </output>
        <max>
            <property>/v22/pfcs/settings/roll-hold-limit</property>
        </max>
    </filter>

    <!-- Tracks a given magnetic heading or GPS track. By using the
         computed heading bug error relative to the given heading, the
         A/P will turn the aircraft left or right depending on which
         turn is the shortest.
    -->
    <pi-simple-controller>
        <name>A/P Heading Hold</name>
        <debug>false</debug>
        <enable>
            <property>/v22/afcs/active/heading-hold</property>
        </enable>
        <input>
            <property>/v22/afcs/internal/heading-bug-error-deg</property>
        </input>
        <reference>
            <value>0</value>
        </reference>
        <output>
            <property>/v22/pfcs/target/roll-deg</property>
        </output>
        <config>
            <Kp>
                <property>/v22/afcs/internal/heading-kp</property>
            </Kp>
            <Ki>0.0</Ki>
            <u_min>
                <property>/v22/afcs/internal/maximum-heading-roll-deg</property>
                <scale>-1.0</scale>
            </u_min>
            <u_max>
                <property>/v22/afcs/internal/maximum-heading-roll-deg</property>
            </u_max>
        </config>
    </pi-simple-controller>

    <!-- Enable FBW Roll Hold if one of the A/P Roll Axis modes
         are enabled.
    -->
    <logic>
        <name>A/P Roll Axis Modes Dependency FBW Roll Hold</name>
        <input>
            <or>
                <equals>
                    <property>/autopilot/locks/heading</property>
                    <value>wing-leveler</value>
                </equals>
                <property>/v22/afcs/active/heading-hold</property>
            </or>
        </input>
        <output>
            <property>/v22/pfcs/active/roll-hold</property>
        </output>
    </logic>

    <!-- ================================================================== -->
    <!-- Pitch Axis Modes                                                   -->
    <!-- ================================================================== -->

    <filter>
        <name>A/P Pitch Hold</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <condition>
                <and>
                    <equals>
                        <property>/autopilot/locks/altitude</property>
                        <value>pitch-hold</value>
                    </equals>
                    <not>
                        <property>/v22/afcs/active/gs-hold</property>
                    </not>
                </and>
            </condition>
        </enable>
        <input>
            <property>/autopilot/settings/target-pitch-deg</property>
        </input>
        <output>
            <property>/v22/pfcs/target/pitch-deg</property>
        </output>
    </filter>

    <!-- Tracks a given altitude -->
    <pi-simple-controller>
        <name>A/P Altitude Hold</name>
        <debug>false</debug>
        <enable>
            <condition>
                <and>
                    <equals>
                        <property>/autopilot/locks/altitude</property>
                        <value>altitude-hold</value>
                    </equals>
                    <not>
                        <property>/v22/afcs/active/gs-hold</property>
                    </not>
                </and>
            </condition>
        </enable>
        <input>
            <property>/instrumentation/altimeter/indicated-altitude-ft</property>
        </input>
        <reference>
            <property>/autopilot/settings/target-altitude-ft</property>
        </reference>
        <output>
            <property>/v22/afcs/target/vs-fps</property>
        </output>
        <config>
            <Kp>0.15</Kp>
            <Ki>0.01</Ki>
            <u_min>-40.0</u_min>
            <u_max>40.0</u_max>
        </config>
    </pi-simple-controller>

    <!-- Enable A/P NAV1 Glideslope if glideslope is in range and NAV1
         mode selected in A/P.
    -->
    <logic>
        <name>A/P NAV1 Glideslope On/Off Switcher</name>
        <input>
            <and>
                <equals>
                    <property>/v22/afcs/locks/altitude</property>
                    <value>gs1-hold</value>
                </equals>
                <property>/instrumentation/nav[0]/has-gs</property>
                <property>/instrumentation/nav[0]/gs-in-range</property>
            </and>
        </input>
        <output>
            <property>/v22/afcs/active/gs-hold</property>
        </output>
    </logic>

    <!-- Tracks the glideslope of the current NAV1 signal -->
    <filter>
        <name>A/P NAV1 Glideslope</name>
        <type>gain</type>
        <gain>1.0</gain>
        <enable>
            <property>/v22/afcs/active/gs-hold</property>
        </enable>
        <input>
            <property>/instrumentation/nav[0]/gs-rate-of-climb</property>
        </input>
        <output>
            <property>/v22/afcs/target/vs-fps</property>
        </output>
    </filter>

    <!-- Tracks the vertical speed (in fpm) set in the A/P -->
    <filter>
        <name>A/P V/S Hold</name>
        <type>gain</type>

        <!-- Multiply by 1/60 to convert from fpm to fps -->
        <gain>0.01666666</gain>

        <enable>
            <condition>
                <equals>
                    <property>/autopilot/locks/altitude</property>
                    <value>vertical-speed-hold</value>
                </equals>
                <not>
                    <property>/v22/afcs/active/gs-hold</property>
                </not>
            </condition>
        </enable>
        <input>
            <property>/autopilot/settings/vertical-speed-fpm</property>
        </input>
        <output>
            <property>/v22/afcs/target/vs-fps</property>
        </output>
    </filter>

    <logic>
        <name>A/P Vertical Speed On/Off Switcher</name>
        <input>
            <or>
                <equals>
                    <property>/autopilot/locks/altitude</property>
                    <value>vertical-speed-hold</value>
                </equals>
                <equals>
                    <property>/autopilot/locks/altitude</property>
                    <value>altitude-hold</value>
                </equals>
                <property>/v22/afcs/active/gs-hold</property>
            </or>
        </input>
        <output>
            <property>/v22/afcs/active/vs-hold</property>
        </output>
    </logic>

    <!-- Tracks a given vertical speed (in fps), set by the pilot
         or by the NAV1 glideslope signal.
    -->
    <pid-controller>
        <name>A/P Vertical Speed Hold</name>
        <debug>false</debug>
        <enable>
            <property>/v22/afcs/active/vs-hold</property>
        </enable>
        <input>
            <property>/velocities/vertical-speed-fps</property>
        </input>
        <reference>
            <property>/v22/afcs/target/vs-fps</property>
        </reference>
        <output>
            <property>/v22/pfcs/target/pitch-deg</property>
        </output>
        <config>
            <Kp>0.52</Kp>
            <Ti>3.0</Ti>
            <Td>0.0</Td>
            <u_min>
                <property>/v22/pfcs/settings/pitch-hold-min</property>
            </u_min>
            <u_max>
                <property>/v22/pfcs/settings/pitch-hold-max</property>
            </u_max>
        </config>
    </pid-controller>

    <!-- Enable FBW Pitch Hold if A/P Pitch Hold or A/P VS Hold is
         enabled.
    -->
    <logic>
        <name>A/P Pitch Hold and Vertical Speed Hold Dependency FBW Pitch Hold</name>
        <input>
            <or>
                <equals>
                    <property>/autopilot/locks/altitude</property>
                    <value>pitch-hold</value>
                </equals>
                <property>/v22/afcs/active/vs-hold</property>
            </or>
        </input>
        <output>
            <property>/v22/pfcs/active/pitch-hold</property>
        </output>
    </logic>

</PropertyList>
