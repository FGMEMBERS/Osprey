<?xml version="1.0"?>

<PropertyList>

    <!-- Following PID controllers and filters implement the Fly-By-Wire system.

         To test the response of a PID controller, set <debug> to true, modify
         <reference> to use a certain <value>, and then reload the autopilot
         via the Debug menu in FlightGear. The controller should start tracking
         the given <value>. Copy and paste the debug output to a file called
         "debug-output" and extract the first 200 (for example) input values
         and save those to another file called "pid-samples":

            grep input debug-output | cut -d " " -f 5 | head -n 200 > pid-samples

         Then start gnuplot and execute:

            plot "pid-samples" with lines

         General work flow is:

         1) Pause FlightGear
         2) Make some modifications to a controller
         3) Reload the autopilot via the Debug menu
         4) Unpause
         5) Pause FlightGear again after a couple of seconds
         6) Analyze the debug output
    -->

    <!-- ================================================================== -->
    <!-- Roll Axis Modes                                                    -->
    <!-- ================================================================== -->

    <!-- Tracks a given roll rate. The target roll rate is limited to
         be no greater than the roll rate limit.
    -->
    <pid-controller>
        <name>FBW Roll Rate</name>
        <debug>false</debug>
        <enable>
            <property>/controls/flight/fbw/active/roll-rate</property>
        </enable>
        <input>
            <property>/orientation/roll-rate-degps</property>
        </input>
        <reference>
            <property>/controls/flight/fbw/target/roll-rate</property>
            <min>
                <property>/controls/flight/fbw/settings/roll-rate-limit</property>
                <scale>-1.0</scale>
            </min>
            <max>
                <property>/controls/flight/fbw/settings/roll-rate-limit</property>
            </max>
        </reference>
        <output>
            <property>/controls/flight/fbw/output/aileron</property>
        </output>
        <config>
            <!-- Response should be something like Docs/fbw-roll-rate.png -->
            <Kp>0.016</Kp>
            <Ti>1.0</Ti>
            <Td>0.0002</Td>
            <u_min>-1.0</u_min>
            <u_max>1.0</u_max>
        </config>
    </pid-controller>

    <!-- Connects the stick directly to the ailerons servos, bypassing
         any PID controllers, giving the pilot direct unfiltered
         control over the ailerons.
    -->
    <filter>
        <name>Direct Mode Stick Roll Rate</name>
        <type>gain</type>
        <gain>
            <property>/controls/flight/fbw/settings/direct-roll-rate-gain</property>
            <abs type="bool">true</abs>
            <max>1.0</max>
        </gain>
        <enable>
            <condition>
                <not>
                    <property>/controls/flight/fbw/active/roll-rate</property>
                </not>
            </condition>
        </enable>
        <input>
            <property>/controls/flight/fbw/target/roll</property>
        </input>
        <output>
            <property>/controls/flight/fbw/output/aileron</property>
        </output>
    </filter>

    <!-- Connects the stick to either the FBW target roll hold or target
         roll rate.
    -->
    <filter>
        <name>FBW Stick Roll</name>
        <type>gain</type>
        <gain>100.0</gain>
        <enable>
            <condition>
                <and>
                    <or>
                        <property>/controls/flight/fbw/active/roll-rate</property>
                        <property>/controls/flight/fbw/active/roll-hold</property>
                    </or>
                    <not>
                        <equals>
                            <property>/autopilot/locks/heading</property>
                            <value>wing-leveler</value>
                        </equals>
                    </not>
                </and>
            </condition>
        </enable>
        <input>
            <property>/controls/flight/fbw/target/roll</property>
        </input>
        <output>
            <condition>
                <property>/controls/flight/fbw/active/roll-hold</property>
            </condition>
            <property>/controls/flight/fbw/target/roll-deg</property>
        </output>
        <output>
            <condition>
                <property>/controls/flight/fbw/active/roll-rate</property>
            </condition>
            <property>/controls/flight/fbw/target/roll-rate</property>
        </output>
    </filter>

    <!-- Tracks a given roll. The roll is limited to be within the roll
         hold limit so that the pilot can never make the aircraft bank
         more than this limit allows. -->
    <pid-controller>
        <name>FBW Roll Hold</name>
        <debug>false</debug>
        <enable>
            <property>/controls/flight/fbw/active/roll-hold</property>
        </enable>
        <input>
            <property>/orientation/roll-deg</property>
        </input>
        <reference>
            <property>/controls/flight/fbw/target/roll-deg</property>
            <min>
                <property>/controls/flight/fbw/settings/roll-hold-limit</property>
                <scale>-1.0</scale>
            </min>
            <max>
                <property>/controls/flight/fbw/settings/roll-hold-limit</property>
            </max>
        </reference>
        <output>
            <property>/controls/flight/fbw/target/roll-rate</property>
        </output>
        <config>
            <!-- TODO Response too quick, should have slower response and less overshoot -->
            <Kp>2.0</Kp>
            <Ti>3.5</Ti>
            <Td>0.0</Td>
            <u_min>
                <property>/controls/flight/fbw/settings/roll-rate-limit</property>
                <scale>-1.0</scale>
            </u_min>
            <u_max>
                <property>/controls/flight/fbw/settings/roll-rate-limit</property>
            </u_max>
        </config>
    </pid-controller>

    <!-- Enable FBW Roll Rate if FBW Roll Hold is enabled -->
    <logic>
        <name>FBW Roll Hold Dependency FBW Roll Rate</name>
        <enable>
            <property>/controls/flight/fbw/active/roll-hold</property>
        </enable>
        <input>
            <true />
        </input>
        <output>
            <property>/controls/flight/fbw/active/roll-rate</property>
        </output>
    </logic>

    <!-- ================================================================== -->
    <!-- Pitch Axis Modes                                                   -->
    <!-- ================================================================== -->

    <!-- Tracks a given pitch rate. The pitch rate can be no greater
         than the pitch rate limit.
    -->
    <pid-controller>
        <name>FBW Pitch Rate</name>
        <debug>false</debug>
        <enable>
            <property>/controls/flight/fbw/active/pitch-rate</property>
        </enable>
        <input>
            <property>/orientation/pitch-rate-degps</property>
        </input>
        <reference>
            <property>/controls/flight/fbw/target/pitch-rate</property>
            <min>
                <property>/controls/flight/fbw/settings/pitch-rate-limit</property>
                <scale>-1.0</scale>
            </min>
            <max>
                <property>/controls/flight/fbw/settings/pitch-rate-limit</property>
            </max>
            <scale>-1.0</scale>
        </reference>
        <output>
            <property>/controls/flight/fbw/output/elevator</property>
        </output>
        <config>
            <Kp>-0.016</Kp>
            <Ti>0.07</Ti>
            <Td>0.0002</Td>
            <beta>0.1</beta>
            <u_min>-1.0</u_min>
            <u_max>1.0</u_max>
        </config>
    </pid-controller>

    <!-- Connects the stick directly to the elevator servos, bypassing
         any PID controllers, giving the pilot direct unfiltered
         control over the elevator.
    -->
    <filter>
        <name>Direct Mode Stick Pitch Rate</name>
        <type>gain</type>
        <gain>
            <property>/controls/flight/fbw/settings/direct-pitch-rate-gain</property>
            <abs type="bool">true</abs>
            <max>1.0</max>
        </gain>
        <enable>
            <condition>
                <not>
                    <property>/controls/flight/fbw/active/pitch-rate</property>
                </not>
            </condition>
        </enable>
        <input>
            <property>/controls/flight/fbw/target/pitch</property>
        </input>
        <output>
            <property>/controls/flight/fbw/output/elevator</property>
        </output>
    </filter>

    <!-- Connects the stick to either the FBW target pitch hold or target
         pitch rate.
    -->
    <filter>
        <name>FBW Stick Pitch</name>
        <type>gain</type>
        <gain>100.0</gain>
        <enable>
            <condition>
                <and>
                    <or>
                        <property>/controls/flight/fbw/active/pitch-rate</property>
                        <property>/controls/flight/fbw/active/pitch-hold</property>
                    </or>
                    <not>
                        <equals>
                            <property>/autopilot/locks/altitude</property>
                            <value>pitch-hold</value>
                        </equals>
                    </not>
                </and>
            </condition>
        </enable>
        <input>
            <property>/controls/flight/fbw/target/pitch</property>
        </input>
        <output>
            <condition>
                <property>/controls/flight/fbw/active/pitch-hold</property>
            </condition>
            <property>/controls/flight/fbw/target/pitch-deg</property>
        </output>
        <output>
            <condition>
                <property>/controls/flight/fbw/active/pitch-rate</property>
            </condition>
            <property>/controls/flight/fbw/target/pitch-rate</property>
        </output>
    </filter>

    <!-- Tracks a given pitch. The pitch is limited to be greater than
         the minimum pitch limit and less than the maximum pitch limit.
    -->
    <pid-controller>
        <name>FBW Pitch Hold</name>
        <debug>false</debug>
        <enable>
            <property>/controls/flight/fbw/active/pitch-hold</property>
        </enable>
        <input>
            <property>/orientation/pitch-deg</property>
        </input>
        <reference>
            <property>/controls/flight/fbw/target/pitch-deg</property>
            <min>
                <property>/controls/flight/fbw/settings/pitch-hold-min</property>
            </min>
            <max>
                <property>/controls/flight/fbw/settings/pitch-hold-max</property>
            </max>
        </reference>
        <output>
            <property>/controls/flight/fbw/target/pitch-rate</property>
        </output>
        <config>
            <!-- Response should be something like Docs/fbw-pitch-hold.png -->
            <Kp>-1.65</Kp>
            <Ti>6.0</Ti>
            <Td>0.0</Td>
            <u_min>
                <property>/controls/flight/fbw/settings/pitch-rate-limit</property>
                <scale>-1.0</scale>
            </u_min>
            <u_max>
                <property>/controls/flight/fbw/settings/pitch-rate-limit</property>
            </u_max>
        </config>
    </pid-controller>

    <!-- Enable FBW Pitch Rate if FBW Pitch Hold is enabled -->
    <logic>
        <name>FBW Pitch Hold Dependency FBW Pitch Rate</name>
        <enable>
            <property>/controls/flight/fbw/active/pitch-hold</property>
        </enable>
        <input>
            <true />
        </input>
        <output>
            <property>/controls/flight/fbw/active/pitch-rate</property>
        </output>
    </logic>

</PropertyList>
